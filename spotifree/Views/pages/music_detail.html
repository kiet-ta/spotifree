<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Player</title>
    <style>
        :root {
            --bg-color: #282828;
            --card-color: #1e1e1e;
            --text-primary-color: #ffffff;
            --text-secondary-color: #b3b3b3;
            --accent-color: #1DB954;
            --highlight-color: #535353;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary-color);
            display: flex;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* --- BỐ CỤC MỚI: 2 CỘT --- */
        .main-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* Cột 1: Trình phát nhạc */
        .player-column {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 30px;
            /* --- CSS MỚI: Đảm bảo các nút position absolute --- */
            position: relative;
        }

        /* Cột 2: Danh sách phát */
        .playlist-column {
            width: 300px;
            background-color: #121212;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #000;
            transition: width 0.3s ease, padding 0.3s ease;
        }

        #playlist-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--highlight-color);
            padding-bottom: 10px;
        }

        /* --- NÚT ẨN/HIỆN THƯ VIỆN (WPF) --- */
        #toggleLibraryBtn {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: #444;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            z-index: 100;
        }

            #toggleLibraryBtn:hover {
                background-color: var(--highlight-color);
            }

        /* --- NÚT MŨI TÊN MỚI (ĐỂ ẨN/HIỆN PLAYLIST HTML) --- */
        #togglePlaylistBtn {
            position: absolute;
            top: 20px;
            right: 20px; /* Đặt ở góc phải */
            background-color: #444;
            border: none;
            color: white;
            width: 38px; /* Vuông vắn hơn */
            height: 38px;
            padding: 8px;
            border-radius: 50%; /* Làm nó tròn */
            cursor: pointer;
            font-size: 14px;
            z-index: 100;
        }

            #togglePlaylistBtn:hover {
                background-color: var(--highlight-color);
            }

            #togglePlaylistBtn svg {
                fill: white;
                width: 100%;
                height: 100%;
                /* Thêm hiệu ứng xoay */
                transition: transform 0.3s ease;
            }
        /* --- KẾT THÚC CSS MỚI --- */


        /* Style cho mỗi bài hát trong danh sách phát */
        .playlist-item {
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: background-color 0.2s;
            position: relative;
            overflow: hidden;
        }

            .playlist-item:hover {
                background-color: var(--highlight-color);
            }

            .playlist-item.active {
                background-color: var(--accent-color);
                color: #fff;
            }

            .playlist-item .title {
                font-weight: 500;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                padding-right: 25px;
            }

            .playlist-item .artist {
                font-size: 12px;
                color: var(--text-secondary-color);
            }

            .playlist-item.active .artist {
                color: #eee;
            }

            .playlist-item .delete-btn {
                position: absolute;
                right: 5px;
                top: 50%;
                transform: translateY(-50%);
                color: var(--text-secondary-color);
                background: none;
                border: none;
                font-size: 20px;
                font-weight: bold;
                cursor: pointer;
                display: none;
                line-height: 1;
                padding: 5px;
            }

            .playlist-item:hover .delete-btn {
                display: inline-block;
            }

            .playlist-item .delete-btn:hover {
                color: var(--text-primary-color);
            }

        /* Thẻ trình phát nhạc (giữ nguyên) */
        .player-card {
            background-color: var(--card-color);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            width: 350px;
            padding: 30px;
            box-sizing: border-box;
            text-align: center;
        }

        .cover-art-wrapper {
            width: 100%;
            padding-bottom: 100%;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background-color: #333;
        }

        #coverArt {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #songTitle {
            font-size: 24px;
            font-weight: 600;
            margin: 20px 0 5px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #songArtist {
            font-size: 16px;
            font-weight: 400;
            color: var(--text-secondary-color);
            margin: 0 0 20px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .main-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .main-control-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
        }

            .main-control-btn svg {
                width: 24px;
                height: 24px;
                fill: var(--text-secondary-color);
                transition: fill 0.2s;
            }

            .main-control-btn:hover svg {
                fill: var(--text-primary-color);
            }

        #playPauseButton {
            background-color: var(--text-primary-color);
            border-radius: 50%;
            padding: 12px;
            margin: 0 5px;
        }

            #playPauseButton svg {
                width: 28px;
                height: 28px;
                fill: #000;
            }

            #playPauseButton:hover {
                transform: scale(1.05);
                background-color: var(--accent-color);
            }

        .sliders {
            margin-top: 20px;
        }

            .sliders input[type="range"] {
                width: 90%;
                cursor: pointer;
                -webkit-appearance: none;
                appearance: none;
                background: #535353;
                height: 4px;
                border-radius: 2px;
                outline: none;
            }

                .sliders input[type="range"]::-webkit-slider-thumb {
                    -webkit-appearance: none;
                    appearance: none;
                    width: 16px;
                    height: 16px;
                    background: var(--text-primary-color);
                    border-radius: 50%;
                    cursor: pointer;
                }

        #timeDisplay {
            color: var(--text-secondary-color);
            margin-top: 5px;
            font-size: 12px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
            gap: 10px;
        }

            .volume-control svg {
                width: 20px;
                height: 20px;
                fill: var(--text-secondary-color);
            }

            .volume-control input[type="range"] {
                width: 100px;
            }

        .secondary-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }

        .control-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            opacity: 0.7;
        }

            .control-btn svg {
                width: 20px;
                height: 20px;
                fill: var(--text-secondary-color);
                transition: fill 0.2s;
            }

            .control-btn.active {
                opacity: 1;
            }

                .control-btn.active svg {
                    fill: var(--accent-color);
                }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="player-column">

            <button id="toggleLibraryBtn" title="Ẩn/Hiện Thư viện">☰ Thư viện</button>

            <button id="togglePlaylistBtn" title="Ẩn/Hiện Danh sách phát">
                <svg viewBox="0 0 24 24">
                    <path d="M8.5 5l7.5 7.5-7.5 7.5" />
                </svg>
            </button>

            <div class="player-card">
                <div class="cover-art-wrapper">
                    <img id="coverArt" src="https://placehold.co/300x300/1e1e1e/b3b3b3?text=WPF+Player" alt="Cover Art">
                </div>

                <h2 id="songTitle">WPF Music Player</h2>
                <p id="songArtist">MVVM + WebView2</p>

                <audio id="audioPlayer" style="display: none;"></audio>

                <div class="sliders">
                    <input type="range" id="seekSlider" min="0" max="100" value="0">
                    <div id="timeDisplay">0:00 / 0:00</div>
                </div>

                <div class="main-controls">
                    <button class="main-control-btn" id="prevButton" title="Previous">
                        <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z" /></svg>
                    </button>

                    <button class="main-control-btn" id="rewindButton" title="Tua lùi 5s">
                        <svg viewBox="0 0 24 24">
                            <path d="M11 6v12l-8.5-6zM20 6v12l-8.5-6z" />
                        </svg>
                    </button>

                    <button class="main-control-btn" id="playPauseButton" title="Play">
                        <svg id="playPauseIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg>
                    </button>

                    <button class="main-control-btn" id="forwardButton" title="Tua tới 5s">
                        <svg viewBox="0 0 24 24"><path d="M13 6v12l8.5-6L13 6zM4 18l8.5-6L4 6v12z" /></svg>
                    </button>

                    <button class="main-control-btn" id="nextButton" title="Next">
                        <svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" /></svg>
                    </button>
                </div>
                <div class="secondary-controls">
                    <div class="volume-control">
                        <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" /></svg>
                        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
                    </div>

                    <button class="control-btn" id="replayButton" title="Replay (Lặp lại 1 bài)">
                        <svg viewBox="0 0 24 24"><path d="M7,7h10v3l4-4l-4-4v3H5v6h2V7z M17,17H7v-3l-4,4l4,4v-3h12v-6h-2V17z M13,12.5V11h-2v1.5H9V14h2v1.5h2V14h2v-1.5H13z" /></svg>
                    </button>

                    <button class="control-btn" id="repeatButton" title="Repeat (Lặp lại danh sách)">
                        <svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" /></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="playlist-column" id="playlist-container">
            <div id="playlist-title">Danh sách phát</div>
            <div id="playlist-items">
            </div>
        </div>
    </div>

    <script>
        // --- CÁC THÀNH PHẦN DOM ---
        const toggleLibraryBtn = document.getElementById('toggleLibraryBtn');
        const audioPlayer = document.getElementById('audioPlayer');
        const coverArt = document.getElementById('coverArt');
        const songTitle = document.getElementById('songTitle');
        const songArtist = document.getElementById('songArtist');
        const seekSlider = document.getElementById('seekSlider');
        const volumeSlider = document.getElementById('volumeSlider');
        const timeDisplay = document.getElementById('timeDisplay');
        const playlistItemsContainer = document.getElementById('playlist-items');
        const playlistContainer = document.getElementById('playlist-container');

        // --- DOM MỚI: Nút mũi tên và icon của nó ---
        const togglePlaylistBtn = document.getElementById('togglePlaylistBtn');
        const playlistToggleIcon = togglePlaylistBtn.querySelector('svg');

        // Nút điều khiển
        const playPauseButton = document.getElementById('playPauseButton');
        const playPauseIcon = document.getElementById('playPauseIcon');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const replayButton = document.getElementById('replayButton');
        const repeatButton = document.getElementById('repeatButton');
        const rewindButton = document.getElementById('rewindButton');
        const forwardButton = document.getElementById('forwardButton');

        // SVG Icons
        const playIcon = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
        const pauseIcon = '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';

        // --- TRẠNG THÁI (STATE) CỦA TRÌNH PHÁT ---
        let playlist = [];
        let currentPlaylistIndex = -1;
        let isReplayOne = false;
        let isRepeatPlaylist = false;
        let isPlaylistVisible = true; // Bắt đầu với trạng thái hiện

        // --- HÀM GIAO TIẾP VỚI C# ---
        function postMessageToCSharp(message) {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage(message);
            } else {
                console.warn("postMessage is not available.");
            }
        }

        window.addToPlaylist = (song) => {
            if (!song || !song.FilePath) return;
            addSongsToInternalPlaylist([song]);
            //playlist.push(song);
            //renderPlaylist();

            //if (playlist.length === 1) {
            //    currentPlaylistIndex = 0;
            //    loadSong(currentPlaylistIndex);
            //}
        };

        // 2. HÀM MỚI: C# gọi hàm này để thêm NHIỀU bài hát
        window.addMultipleToPlaylist = (songs) => {
            if (!songs || !Array.isArray(songs) || songs.length === 0) return;
            addSongsToInternalPlaylist(songs);
        };

        // 3. HÀM MỚI: Hàm nội bộ để xử lý logic (tránh lặp code)
        function addSongsToInternalPlaylist(songs) {
            const wasPlaylistEmpty = playlist.length === 0;

            // Thêm tất cả bài hát vào mảng playlist
            songs.forEach(song => {
                if (song && song.FilePath) {
                    // Tùy chọn: Bạn có thể thêm kiểm tra trùng lặp ở đây
                    // if (!playlist.some(p => p.FilePath === song.FilePath)) {
                    playlist.push(song);
                    // }
                }
            });

            // Chỉ vẽ lại giao diện 1 LẦN duy nhất (tốt cho hiệu năng)
            renderPlaylist();

            // Nếu playlist trống trước đó, hãy chuẩn bị bài hát đầu tiên
            if (wasPlaylistEmpty && playlist.length > 0) {
                currentPlaylistIndex = 0;
                loadSong(currentPlaylistIndex);
            }
        }

        window.loadFullLibrary = (library) => {
            playlist = library;
            renderPlaylist();

            if (playlist.length > 0) {
                playSongFromPlaylist(0);
            }
        };

        window.receiveCommand = (command) => {
            console.log("C# command:", command);
        };

        // --- HÀM ẨN/HIỆN CỘT PLAYLIST (HTML) ---
        function showPlaylist(show) {
            if (show) {
                playlistContainer.style.width = '300px';
                playlistContainer.style.padding = '20px';
                playlistContainer.style.overflowY = 'auto';
                playlistToggleIcon.style.transform = 'rotate(0deg)'; // Mũi tên >
                isPlaylistVisible = true;
            } else {
                playlistContainer.style.width = '0px';
                playlistContainer.style.padding = '0px';
                playlistContainer.style.overflowY = 'hidden';
                playlistToggleIcon.style.transform = 'rotate(180deg)'; // Mũi tên <
                isPlaylistVisible = false;
            }
        }

        // --- HÀM XÓA BÀI HÁT ---
        function removeSongFromPlaylist(index) {
            let wasPlaying = (index === currentPlaylistIndex);
            playlist.splice(index, 1);

            if (index < currentPlaylistIndex) {
                currentPlaylistIndex--;
            }
            else if (wasPlaying) {
                audioPlayer.pause();
                audioPlayer.src = '';

                if (playlist.length === 0) {
                    currentPlaylistIndex = -1;
                    songTitle.textContent = "WPF Music Player";
                    songArtist.textContent = "MVVM + WebView2";
                    coverArt.src = "https://placehold.co/300x300/1e1e1e/b3b3b3?text=WPF+Player";
                    updatePlayPauseIcon(false);
                }
                else if (index >= playlist.length) {
                    currentPlaylistIndex = 0;
                    playSongFromPlaylist(currentPlaylistIndex);
                }
                else {
                    currentPlaylistIndex = index;
                    playSongFromPlaylist(currentPlaylistIndex);
                }
            }
            renderPlaylist();
        }

        // --- LOGIC CỦA TRÌNH PHÁT NHẠC ---
        function loadSong(index) {
            const song = playlist[index];
            if (!song) return;

            songTitle.textContent = song.Title || "Unknown Title";
            songArtist.textContent = song.Artist || "Unknown Artist";
            coverArt.src = song.CoverArtUrl || "https://placehold.co/300x300/1e1e1e/b3b3b3?text=Music";

            let filePath = song.FilePath;
            const driveLetter = filePath.substring(0, 1).toLowerCase();
            const hostName = `${driveLetter}.drive.local`;
            const webUrl = `https://${hostName}${filePath.substring(2).replace(/\\/g, '/')}`;

            audioPlayer.src = webUrl;
        }

        function playSongFromPlaylist(index) {
            if (index < 0 || index >= playlist.length) {
                console.log("Playlist index out of bounds.");
                return;
            }

            currentPlaylistIndex = index;
            loadSong(currentPlaylistIndex);
            audioPlayer.play().catch(e => console.error("Lỗi phát nhạc:", e));

            renderPlaylist();
        }

        // --- HÀM ĐIỀU KHIỂN (PLAY, NEXT, PREV) ---
        function playNext() {
            let nextIndex = currentPlaylistIndex + 1;

            if (nextIndex >= playlist.length) {
                if (isRepeatPlaylist) {
                    nextIndex = 0;
                } else {
                    return;
                }
            }
            playSongFromPlaylist(nextIndex);
        }

        function playPrevious() {
            if (audioPlayer.currentTime > 3) {
                audioPlayer.currentTime = 0;
            } else {
                let prevIndex = currentPlaylistIndex - 1;

                if (prevIndex < 0) {
                    if (isRepeatPlaylist && playlist.length > 0) {
                        prevIndex = playlist.length - 1;
                    } else {
                        prevIndex = 0;
                    }
                }
                playSongFromPlaylist(prevIndex);
            }
        }

        // --- HÀM VẼ LẠI GIAO DIỆN ---
        function renderPlaylist() {
            playlistItemsContainer.innerHTML = "";

            if (playlist.length === 0) {
                playlistItemsContainer.innerHTML = '<div class="playlist-item artist">Thêm bài hát từ Thư viện...</div>';
                return;
            }

            playlist.forEach((song, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                if (index === currentPlaylistIndex) {
                    item.classList.add('active');
                }

                item.innerHTML = `
                                <button class="delete-btn" title="Xóa khỏi danh sách">×</button>
                                <div class="title">${song.Title}</div>
                                <div class="artist">${song.Artist}</div>
                            `;

                const deleteBtn = item.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeSongFromPlaylist(index);
                });

                item.addEventListener('click', () => {
                    playSongFromPlaylist(index);
                });

                playlistItemsContainer.appendChild(item);
            });
        }

        function updatePlayPauseIcon(isPlaying) {
            playPauseIcon.innerHTML = isPlaying ? pauseIcon : playIcon;
            playPauseButton.title = isPlaying ? "Pause" : "Play";
        }

        // --- GẮN SỰ KIỆN (EVENT LISTENERS) ---

        // Nút '☰ Thư viện' (Chỉ gửi lệnh cho C#)
        toggleLibraryBtn.addEventListener('click', () => {
            // Chỉ gửi tin nhắn cho C# (để toggle cột WPF)
            postMessageToCSharp({ type: 'toggleLibrary' });
        });

        // NÚT MỚI: Nút mũi tên (Chỉ toggle playlist HTML)
        togglePlaylistBtn.addEventListener('click', () => {
            showPlaylist(!isPlaylistVisible);
        });

        // Nút Play/Pause chính
        playPauseButton.addEventListener('click', () => {
            if (audioPlayer.paused) {
                if (currentPlaylistIndex === -1 && playlist.length > 0) {
                    playSongFromPlaylist(0);
                } else {
                    audioPlayer.play();
                }
            } else {
                audioPlayer.pause();
            }
        });

        // Nút Next, Previous
        nextButton.addEventListener('click', playNext);
        prevButton.addEventListener('click', playPrevious);

        // Nút Tua 5s
        forwardButton.addEventListener('click', () => {
            audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
        });
        rewindButton.addEventListener('click', () => {
            audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
        });

        // Khi bài hát kết thúc
        audioPlayer.addEventListener('ended', () => {
            if (isReplayOne) {
                audioPlayer.play();
            } else {
                playNext();
            }
        });

        // Cập nhật trạng thái icon và TỰ ĐỘNG ẨN PLAYLIST
        audioPlayer.addEventListener('play', () => {
            updatePlayPauseIcon(true);
            showPlaylist(false); // <-- YÊU CẦU: TỰ ĐỘNG ẨN KHI PHÁT
        });
        audioPlayer.addEventListener('pause', () => updatePlayPauseIcon(false));

        // Thanh tua (Seek)
        audioPlayer.addEventListener('timeupdate', () => {
            if (audioPlayer.duration) {
                const percentage = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                seekSlider.value = percentage;
                timeDisplay.textContent = formatTime(audioPlayer.currentTime) + " / " + formatTime(audioPlayer.duration);
            }
        });
        seekSlider.addEventListener('input', () => {
            if (audioPlayer.duration) {
                audioPlayer.currentTime = (seekSlider.value / 100) * audioPlayer.duration;
            }
        });

        // Thanh âm lượng
        volumeSlider.addEventListener('input', () => {
            audioPlayer.volume = volumeSlider.value;
        });

        // Nút Lặp lại
        replayButton.addEventListener('click', () => {
            isReplayOne = !isReplayOne;
            replayButton.classList.toggle('active', isReplayOne);
            if (isReplayOne) {
                isRepeatPlaylist = false;
                repeatButton.classList.remove('active');
            }
        });
        repeatButton.addEventListener('click', () => {
            isRepeatPlaylist = !isRepeatPlaylist;
            repeatButton.classList.toggle('active', isRepeatPlaylist);
            if (isRepeatPlaylist) {
                isReplayOne = false;
                replayButton.classList.remove('active');
            }
        });

        // Hàm tiện ích
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // Khởi tạo
        renderPlaylist(); // Vẽ danh sách phát trống ban đầu
    </script>
</body>
</html>